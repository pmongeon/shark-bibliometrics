---
title: "Mapping Shark Research"
author: "Rémi Toupin and Philippe Mongeon"
date: "2020-12-07"
abstract: "This is an abstract"
output: 
  html_document:
    toc: true 
    toc_float:       
      collapsed: false
    toc_depth: 2
    number_sections: false 
    theme: lumen
    highlight: tango
---

# Summary

# Collecting the publications

We collect the title, abstract, and keywords of all publications containing the term “shark” and published between 1980 and 2020 from the Web of Science (WoS) database hosted by the Centre for Science and Technology Studies (CWTS) using the query below. The resulting dataset can be found on the github repository of the proecet under _data/articles.zip_. 

```{sql eval=FALSE}
SELECT DISTINCT ut, title, abstract, author_keyword INTO #data from wos_2013_text..text_data where CONTAINS(title, 'shark')
union select ut, title, abstract, author_keyword from wos_2013_text..text_data where CONTAINS(title, 'sharks') 
union select ut, title, abstract, author_keyword from wos_2013_text..text_data where CONTAINS(keyword, 'shark')
union select ut, title, abstract, author_keyword from wos_2013_text..text_data where CONTAINS(keyword, 'sharks')
union select ut, title, abstract, author_keyword from wos_2013_text..text_data where CONTAINS(keyword_plus, 'shark')
UNION selectut, title, abstract, author_keyword from wos_2013_text..text_data where CONTAINS(keyword_plus, 'sharks')
UNION select ut, title, abstract, author_keyword from wos_2013_text..text_data where CONTAINS(abstract, 'shark')
UNION SELECT ut, title, abstract, author_keyword from wos_2013_text..text_data WHERE CONTAINS(abstract, 'sharks')
```

Then we retrieve the citations links between those publications with the following query. The resulting dataset can be found on the github repository of the proecet under _data/citations.zip_

```{sql eval=FALSE}
select b.citing_ut, b.cited_ut
from #data a -- this is table generated with our first query
join wos_2013..citation b on b.citing_ut = a.ut
union select b.citing_ut, b.cited_ut
from #data a
join wos_2013..citation b on b.cited_ut = a.ut
```


# Building the network

We then move to R and load the required packages and the publication and citation data.

```{r load-packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(igraph)
library(visNetwork)

Articles <- read_delim(unzip("data/articles.zip"), delim="\t")
Citations <- read_delim(unzip("data/citations.zip"), delim="\t")
Altmetrics <- read_delim(unzip("data/altmetrics.zip"), delim="\t")

#removed unzipped files
file.remove("articles.txt")
file.remove("citations.txt")
file.remove("altmetrics.txt")
```

### bibliographic coupling network

```{r bc network, message=FALSE, warning=FALSE}

BCNetwork <- select(Articles, ut) %>% 
  inner_join(Citations, by=c("ut" = "citing_ut")) %>% 
  inner_join(Citations, by="cited_ut") %>% 
  inner_join(select(Articles,ut), by=c("citing_ut" = "ut")) %>% 
  select(source = ut, target = citing_ut) %>%
  filter(target > source) %>% 
  count(source, target, name = "weight") %>% 
  mutate(type = "undirected")
```

### co-citation network

```{r cc network, message=FALSE, warning=FALSE}
CCNetwork <- select(Articles, ut) %>% 
  inner_join(Citations, by=c("ut" = "cited_ut")) %>% 
  inner_join(Citations, by="citing_ut") %>% 
  inner_join(select(Articles,ut), by=c("cited_ut" = "ut")) %>% 
  select(source = ut, target = cited_ut) %>%
  filter(target > source) %>% 
  count(source, target, name = "weight") %>% 
  mutate(type = "undirected")
```

### combined network

```{r combined network, message=FALSE, warning=FALSE}
# Combined BC+CC network
CCBCNetwork <- rbind(CCNetwork,BCNetwork) %>%
  group_by(source, target, type) %>% 
  summarize(weight = sum(weight)) %>% 
  ungroup()
```

# Identifying the communities

### macro-clusters

```{r macro_cluster, message=FALSE, warning=FALSE}
# create igraph object
network <- graph_from_data_frame(CCBCNetwork, directed = F) %>% simplify(remove.loops = TRUE)

#keep only the main component
V(network)$comp <- components(network)$membership
network <- induced_subgraph(network, V(network)$comp==1)

# Identify communities
V(network)$community <- cluster_louvain(network, weights = c(E(network)$Weight))$membership

# Add macro cluster to the articles table
Articles <- Articles %>% 
  left_join(select(as_data_frame(network, "both")$vertices, name, macro_cluster = community), by=c("ut" = "name"))
            
```

### meso-clusters

```{r meso_cluster, message=FALSE, warning=FALSE}

j = 0
for (i in 1:max(filter(Articles, !is.na(macro_cluster))$macro_cluster)) {

# create igraph object
network <- CCBCNetwork %>% 
  inner_join(select(filter(Articles, macro_cluster == i),ut), by=c("source" = "ut")) %>% 
  inner_join(select(filter(Articles, macro_cluster == i),ut), by=c("target" = "ut")) %>% 
  graph_from_data_frame(directed = F) %>% 
  simplify(remove.loops = TRUE)

#keep only the main component
V(network)$comp <- components(network)$membership
network <- induced_subgraph(network, V(network)$comp==1)

# Identify communities
V(network)$community <- cluster_louvain(network, weights = c(E(network)$Weight))$membership

# List of articles with their community
if (i==1){
x <-  select(as_data_frame(network, "both")$vertices, name, meso_cluster = community) %>% 
  mutate(meso_cluster = meso_cluster+j)
meso_cluster <- select(Articles,ut) %>% 
  inner_join(x, by=c("ut" = "name"))
}
if (i>1){
x <-  select(as_data_frame(network, "both")$vertices, name, meso_cluster = community) %>% 
  mutate(meso_cluster = meso_cluster+j)
meso_cluster <- rbind(meso_cluster, select(Articles,ut) %>% 
  inner_join(x, by=c("ut" = "name")))
}
j = max(meso_cluster$meso_cluster)
}

# Add meso clusters to Articles

Articles <- Articles %>% 
  left_join(meso_cluster, by="ut")

```

### micro-clusters

```{r micro_cluster, message=FALSE, warning=FALSE}

j=0
for (i in 1:max(filter(Articles, !is.na(meso_cluster))$meso_cluster)) {

# create igraph object
network <- CCBCNetwork %>% 
  inner_join(select(filter(Articles, meso_cluster == i),ut), by=c("source" = "ut")) %>% 
  inner_join(select(filter(Articles, meso_cluster == i),ut), by=c("target" = "ut")) %>% 
  graph_from_data_frame(directed = F) %>% 
  simplify(remove.loops = TRUE)

#keep only the main component
V(network)$comp <- components(network)$membership
network <- induced_subgraph(network, V(network)$comp==1)

# Identify communities
V(network)$community <- cluster_louvain(network, weights = c(E(network)$Weight))$membership

# List of articles with their community
if (i==1){
x <-  select(as_data_frame(network, "both")$vertices, name, micro_cluster = community) %>% 
  mutate(micro_cluster = micro_cluster+j)

micro_cluster <- select(Articles,ut) %>% 
  inner_join(x, by=c("ut" = "name"))
}
if (i>1){
x <-  select(as_data_frame(network, "both")$vertices, name, micro_cluster = community) %>% 
  mutate(micro_cluster = micro_cluster+j)
micro_cluster <- rbind(micro_cluster, select(Articles,ut) %>% 
  inner_join(x, by=c("ut" = "name")))
}
j = max(micro_cluster$micro_cluster)
}

Articles <- Articles %>% 
  left_join(micro_cluster, by="ut")

#remove unused objects
remove(x, network, Citations, meso_cluster, micro_cluster,j,i)

# export articles

write_delim(Articles, "data/articles_clusters.txt", delim="\t")
```

# Characterizing the communities

```{r eval = FALSE, message=FALSE}

### ABSTRACT ANALYSIS - WORDS PER COMMUNITY
## =================
# basic string cleaning
## =================

papers <- Articles

#remove rights reserved
papers$abstract <- gsub("\\(C\\).+", " ", papers$abstract)
length(unique(papers$abstract))

#upper cases to lower cases
papers$abstract <- tolower(papers$abstract)

#remove URLs
papers$abstract <- gsub(" ?(f|ht)(tp)(s?)(://)(.*)[.|/](.*)", "", papers$abstract) 

#remove emojis
papers$abstract <- gsub("[^\x01-\x7F]", "", papers$abstract)

#remove numbers
papers$abstract <- gsub("[0-9]+", "", papers$abstract)

#remove lists with / and replace with " " (e.g., wife/phd/friend)
papers$abstract <- gsub("\\/", " ", papers$abstract)

# forward slash -- escape with a double backslash
sub("\\/", " ", "Peace/Love")

#[1] "Peace Love"
length(unique(papers$abstract))
papers <- papers %>% 
  filter(!grepl('null', abstract))
papers <- papers %>% 
  filter(!is.na(abstract))

#remove punctuations
punct <- '[]\\?!\"\'$%&(){}+*/:;,._`|~\\[<=>\\^-]'
papers$abstract <- gsub(punct, "", papers$abstract)

#convert plural to singular
papers$abstract <- gsub("\\bsharks\\b", "shark", papers$abstract)

#remove stop words
data("stop_words")
stop_words <- stop_words %>%
  add_row(word = "shark", lexicon = "SMART") %>%
  add_row(word = "species", lexicon = "SMART")
##=================
#append vertices topics attributes 
#==================

#unnest tokens
abstract_df <- papers %>% 
  unnest_tokens(word, abstract)

#remove NA tokens
abstract_sep <- abstract_df[complete.cases(abstract_df[, 29]),]

#remove stopwords
abstract_fil <- abstract_sep %>%
  filter(!word %in% stop_words$word)

#count word per document - tf-idf
abstract_count_mac <- abstract_fil %>%
  group_by(macro_cluster) %>%
  count(macro_cluster, npapers = n_distinct(name), word, sort = TRUE) %>%
  bind_tf_idf(word, macro_cluster, n) %>%
  arrange(-n) %>%
  top_n(10) %>%
  ungroup()

abstract_count_mes <- abstract_fil %>%
  group_by(meso_cluster) %>%
  count(macro_cluster, meso_cluster, npapers = n_distinct(name), word, sort = TRUE) %>%
  bind_tf_idf(word, meso_cluster, n) %>%
  arrange(-n) %>%
  top_n(10) %>%
  ungroup()

abstract_count_mic <- abstract_fil %>%
  group_by(micro_cluster) %>%
  count(macro_cluster, meso_cluster, micro_cluster, npapers = n_distinct(name), word, sort = TRUE) %>%
  bind_tf_idf(word, micro_cluster, n) %>%
  arrange(-n) %>%
  top_n(10) %>%
  ungroup()

##=================
#create summary table of top words by clusters
##=================

summaryword <- abstract_count_mic %>%
  group_by(micro_cluster) %>%
  summarise(macro_cluster,
            meso_cluster,
            npapers,
            words = paste(word, collapse=", "),
  ) %>%
  slice(1)
summarytable <- summaryword %>%
  select(macro_cluster, meso_cluster, micro_cluster, npapers, words) %>%
  ungroup()
gt_table <- summarytable %>%
  gt(rowname_col = "micro_cluster") %>%
  tab_header(
    title = "Communities of shark research (co-citations and bibliographic coupling)"
  ) %>%
  tab_stubhead(label = "Micro-community") %>%
  cols_label(
    macro_cluster = "Macro-community",
    meso_cluster = "Meso-community",
    npapers = "N papers in community",
    words = "Top 10 words used in papers abstracts",
  )
gt_table <- gt_table %>% 
  tab_style(style = list(
    cell_text(font = "Times", size = px(14))
  ),
  locations = list(cells_body(), cells_stub(), cells_stubhead(), cells_column_labels(1:4))
  ) %>%
  tab_style(style = list(
    cell_text(align = "center", font = "Times", size = px(16), weight = "bolder")
  ),
  locations = list(cells_column_labels(1:4), cells_stubhead(), cells_title())
  ) %>%
  tab_style(style = list(
    cell_text(align = "left")
  ),
  locations = list(cells_body(1:4))
  ) %>%
  tab_style(style = list(
    cell_text(align = "right")
  ),
  locations = list(cells_body(5))
  )
gt_table

```

# Visualizing the communities

```{r viz_macro, message=FALSE, warning=FALSE}

CCBCNetwork %>% 
  inner_join(select(Articles, ut, macro_cluster), by=c("source" = "ut"))%>%
  inner_join(select(Articles, ut, macro_cluster), by=c("target" = "ut")) %>% 
  select(source = macro_cluster.x, target = macro_cluster.y, weight, type) %>%
  filter(target > source) %>% 
  group_by(source, target, type) %>% 
  summarize(weight = sum(weight)) %>% 
  graph_from_data_frame(directed = FALSE) %>% 
  visIgraph()
```

```{r viz_meso, message=FALSE, warning=FALSE}
CCBCNetwork %>% 
  inner_join(select(Articles, ut, meso_cluster), by=c("source" = "ut"))%>%
  inner_join(select(Articles, ut, meso_cluster), by=c("target" = "ut")) %>% 
  select(source = meso_cluster.x, target = meso_cluster.y, weight, type) %>%
  filter(target > source) %>% 
  group_by(source, target, type) %>% 
  summarize(weight = sum(weight)) %>% 
  graph_from_data_frame(directed = FALSE) %>% 
  visIgraph()
```

```{r viz_micro, message=FALSE, warning=FALSE}
CCBCNetwork %>% 
  inner_join(select(Articles, ut, micro_cluster), by=c("source" = "ut"))%>%
  inner_join(select(Articles, ut, micro_cluster), by=c("target" = "ut")) %>% 
  select(source = micro_cluster.x, target = micro_cluster.y, weight, type) %>%
  filter(target > source) %>% 
  group_by(source, target, type) %>% 
  summarize(weight = sum(weight)) %>% 
  graph_from_data_frame(directed = FALSE) %>% 
  visIgraph()
```


# Distribution of indicators

```{r message=FALSE, warning=FALSE}

indicators <- Articles %>%
  left_join(Altmetrics, by="ut") %>% 
  filter(!is.na(total))

impact_dist_macro <- indicators %>% 
  group_by(macro_cluster) %>% 
  summarize(n_articles = n(),
            n_tweets = sum(twitter),
            n_news = sum(news),
            n_policy = sum(policy),
            n_all_indicators = sum(total),
            avg_tweets = mean(twitter),
            avg_news = mean(news),
            avg_policy = mean(policy),
            avg_all_indicators = mean(total)
            ) %>% 
  ungroup() %>% 
  mutate(z_tweets = (avg_tweets-mean(avg_tweets))/sd(avg_tweets),
         z_news = (avg_news-mean(avg_news))/sd(avg_news),
         z_policy = (avg_policy-mean(avg_policy))/sd(avg_policy),
         z_all_indicators = (avg_all_indicators-mean(avg_all_indicators))/sd(avg_all_indicators))
  
impact_dist_meso <- indicators %>% 
  group_by(meso_cluster) %>% 
  summarize(n_articles = n(),
            n_tweets = sum(twitter),
            n_news = sum(news),
            n_policy = sum(policy),
            n_all_indicators = sum(total),
            avg_tweets = mean(twitter),
            avg_news = mean(news),
            avg_policy = mean(policy),
            avg_all_indicators = mean(total)
            ) %>% 
  ungroup() %>% 
  mutate(z_tweets = (avg_tweets-mean(avg_tweets))/sd(avg_tweets),
         z_news = (avg_news-mean(avg_news))/sd(avg_news),
         z_policy = (avg_policy-mean(avg_policy))/sd(avg_policy),
         z_all_indicators = (avg_all_indicators-mean(avg_all_indicators))/sd(avg_all_indicators))

impact_dist_micro <- indicators %>% 
  group_by(micro_cluster) %>% 
  summarize(n_articles = n(),
            n_tweets = sum(twitter),
            n_news = sum(news),
            n_policy = sum(policy),
            n_all_indicators = sum(total),
            avg_tweets = mean(twitter),
            avg_news = mean(news),
            avg_policy = mean(policy),
            avg_all_indicators = mean(total)
            ) %>% 
  ungroup() %>% 
  mutate(z_tweets = (avg_tweets-mean(avg_tweets))/sd(avg_tweets),
         z_news = (avg_news-mean(avg_news))/sd(avg_news),
         z_policy = (avg_policy-mean(avg_policy))/sd(avg_policy),
         z_all_indicators = (avg_all_indicators-mean(avg_all_indicators))/sd(avg_all_indicators))

```


